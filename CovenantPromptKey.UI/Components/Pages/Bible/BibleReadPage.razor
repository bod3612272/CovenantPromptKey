@page "/bible/read"
@page "/bible/read/{BookNumber:int}/{ChapterNumber:int}"
@using CovenantPromptKey.Models.Bible

<PageTitle>聖經閱讀 - CovenantPromptKey</PageTitle>

<link href="css/bible.css" rel="stylesheet" />

<div class="bible-container">
    <div class="bible-page-header">
        <h1 class="bible-page-title">
            <i class="bi bi-book me-2"></i>聖經閱讀
        </h1>
    </div>

    <BibleSubNavigation />

    <!-- 書卷/章節選擇器 -->
    <div class="mb-4">
        <BibleBookSelector 
            BookNumber="@currentBookNumber" 
            ChapterNumber="@currentChapterNumber"
            OnSelectionChanged="OnSelectionChanged"
            ShowQuickAccess="true" />
    </div>

    <!-- 設定面板（可摺疊） -->
    <div class="mb-4">
        <button class="btn btn-sm btn-outline-secondary" type="button" @onclick="ToggleSettings">
            <i class="bi @(showSettings ? "bi-chevron-up" : "bi-chevron-down") me-1"></i>
            顯示設定
        </button>
        <button class="btn btn-sm btn-outline-secondary ms-2" type="button" @onclick="ToggleBookmarks">
            <i class="bi @(showBookmarks ? "bi-chevron-up" : "bi-chevron-down") me-1"></i>
            閱讀記錄
            @if (bookmarks.Any())
            {
                <span class="badge bg-secondary ms-1">@bookmarks.Count</span>
            }
        </button>
        @if (showSettings)
        {
            <div class="mt-2">
                <BibleSettingsPanel Settings="@settings" SettingsChanged="OnSettingsChanged" ShowResetButton="true" />
            </div>
        }
        @if (showBookmarks)
        {
            <div class="mt-2">
                <BibleBookmarkList 
                    Bookmarks="@bookmarks"
                    IsLoading="@isLoadingBookmarks"
                    ShowTitle="false"
                    ShowDate="true"
                    ShowRemoveButton="true"
                    ShowClearButton="true"
                    MaxDisplay="10"
                    PreventNavigation="true"
                    OnBookmarkClick="OnBookmarkClicked"
                    OnBookmarkRemove="OnBookmarkRemoved"
                    OnClearAll="OnClearAllBookmarks" />
            </div>
        }
    </div>

    <!-- 章節導航（上方） -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <BibleChapterNavigator 
            ChapterTitle="@chapterTitle"
            HasPrevious="@hasPreviousChapter"
            HasNext="@hasNextChapter"
            PreviousTitle="@previousChapterTitle"
            NextTitle="@nextChapterTitle"
            OnPrevious="GoToPreviousChapter"
            OnNext="GoToNextChapter" />
        
        <button class="btn btn-outline-primary btn-sm" @onclick="ShowExportDialog" title="導出經文">
            <i class="bi bi-download me-1"></i>導出
        </button>
    </div>

    <!-- 經文內容 -->
    @if (isLoading)
    {
        <div class="bible-loading">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            載入經文中...
        </div>
    }
    else if (verses != null && verses.Any())
    {
        <div class="bible-verses-container" style="@GetContainerStyle()" @ref="versesContainer">
            @foreach (var verse in verses)
            {
                <BibleVerseDisplay 
                    Verse="@verse" 
                    Settings="@settings"
                    IsHighlighted="@(verse.VerseNumber == highlightedVerseNumber)" />
            }
        </div>
    }
    else
    {
        <div class="bible-empty-state">
            <div class="bible-empty-state-icon">
                <i class="bi bi-book"></i>
            </div>
            <p>無法載入經文</p>
            <p class="text-muted small">請嘗試選擇其他章節</p>
        </div>
    }

    <!-- 章節導航（下方） -->
    @if (verses != null && verses.Any())
    {
        <div class="mt-4">
            <BibleChapterNavigator 
                ChapterTitle="@chapterTitle"
                HasPrevious="@hasPreviousChapter"
                HasNext="@hasNextChapter"
                PreviousTitle="@previousChapterTitle"
                NextTitle="@nextChapterTitle"
                OnPrevious="GoToPreviousChapter"
                OnNext="GoToNextChapter" />
        </div>
    }
</div>

<!-- 導出對話框 -->
<BibleExportDialog 
    IsVisible="@showExportDialog"
    BookNumber="@currentBookNumber"
    ChapterNumber="@currentChapterNumber"
    ChapterTitle="@chapterTitle"
    BookName="@currentBookName"
    OnClose="CloseExportDialog"
    OnExportSuccess="OnExportSuccess" />

<!-- Toast 通知 -->
@if (!string.IsNullOrEmpty(toastMessage))
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong class="me-auto">導出</strong>
                <button type="button" class="btn-close" @onclick="() => toastMessage = null"></button>
            </div>
            <div class="toast-body">
                @toastMessage
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int BookNumber { get; set; }

    [Parameter]
    public int ChapterNumber { get; set; }

    [Inject]
    private IBibleReadingService? ReadingService { get; set; }

    [Inject]
    private IBibleSettingsService? SettingsService { get; set; }

    [Inject]
    private IBiblePageStateService? PageStateService { get; set; }

    [Inject]
    private IBibleBookmarkService? BookmarkService { get; set; }

    [Inject]
    private NavigationManager? NavigationManager { get; set; }

    [Inject]
    private IDebugLogService? DebugLogService { get; set; }

    private int currentBookNumber = 1;
    private int currentChapterNumber = 1;
    private int? highlightedVerseNumber;
    private bool initializedFromUrl = false;
    private List<BibleData.VerseWithLocation>? verses;
    private BibleSettings settings = new();
    private bool isLoading = false;
    private bool showSettings = false;
    private bool showBookmarks = false;
    private bool isLoadingBookmarks = false;
    private List<BibleBookmark> bookmarks = new();
    private ElementReference versesContainer;

    // 導出相關
    private bool showExportDialog = false;
    private string currentBookName = "";
    private string? toastMessage;

    // 導航相關
    private string chapterTitle = "";
    private bool hasPreviousChapter;
    private bool hasNextChapter;
    private string? previousChapterTitle;
    private string? nextChapterTitle;

    protected override void OnInitialized()
    {
        DebugLogService?.Log($"[BibleReadPage] OnInitialized 開始", Models.LogLevel.Info);
        DebugLogService?.Log($"[BibleReadPage] URL: {NavigationManager?.Uri}", Models.LogLevel.Info);
        
        // 從 URL 參數初始化
        if (BookNumber > 0)
        {
            currentBookNumber = BookNumber;
            initializedFromUrl = true;
            DebugLogService?.Log($"[BibleReadPage] 從路由參數設定 BookNumber: {BookNumber}", Models.LogLevel.Info);
        }
        if (ChapterNumber > 0)
        {
            currentChapterNumber = ChapterNumber;
            initializedFromUrl = true;
            DebugLogService?.Log($"[BibleReadPage] 從路由參數設定 ChapterNumber: {ChapterNumber}", Models.LogLevel.Info);
        }

        // 解析 query string 參數
        var uri = NavigationManager?.ToAbsoluteUri(NavigationManager.Uri);
        if (uri != null)
        {
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            DebugLogService?.Log($"[BibleReadPage] Query String: {uri.Query}", Models.LogLevel.Info);
            
            // 解析 book 參數（書卷名稱）
            var bookQueryParam = queryParams["book"];
            DebugLogService?.Log($"[BibleReadPage] book 參數: {bookQueryParam ?? "null"}", Models.LogLevel.Info);
            
            if (bookQueryParam is string bookName && !string.IsNullOrEmpty(bookName) && ReadingService != null)
            {
                DebugLogService?.Log($"[BibleReadPage] 嘗試查找書卷名稱: {bookName}", Models.LogLevel.Info);
                var bookNumber = ReadingService.GetBookNumber(bookName);
                DebugLogService?.Log($"[BibleReadPage] GetBookNumber 返回: {bookNumber}", Models.LogLevel.Info);
                
                if (bookNumber > 0)
                {
                    currentBookNumber = bookNumber;
                    initializedFromUrl = true;
                    DebugLogService?.Log($"[BibleReadPage] 設定 currentBookNumber: {bookNumber}", Models.LogLevel.Info);
                }
                else
                {
                    DebugLogService?.Log($"[BibleReadPage] 書卷名稱無效，保持預設值", Models.LogLevel.Warning);
                }
            }
            
            // 解析 chapter 參數
            var chapterQueryParam = queryParams["chapter"];
            DebugLogService?.Log($"[BibleReadPage] chapter 參數: {chapterQueryParam ?? "null"}", Models.LogLevel.Info);
            
            if (chapterQueryParam is string chapterStr && int.TryParse(chapterStr, out var chapterNum))
            {
                currentChapterNumber = chapterNum;
                initializedFromUrl = true;
                DebugLogService?.Log($"[BibleReadPage] 設定 currentChapterNumber: {chapterNum}", Models.LogLevel.Info);
            }
            
            // 解析 verse 參數
            var verseQueryParam = queryParams["verse"];
            if (verseQueryParam is string verseStr && int.TryParse(verseStr, out var verseNum))
            {
                highlightedVerseNumber = verseNum;
                DebugLogService?.Log($"[BibleReadPage] 設定 highlightedVerseNumber: {verseNum}", Models.LogLevel.Info);
            }
        }
        
        DebugLogService?.Log($"[BibleReadPage] OnInitialized 完成 - currentBookNumber: {currentBookNumber}, currentChapterNumber: {currentChapterNumber}", Models.LogLevel.Info);
    }

    protected override async Task OnParametersSetAsync()
    {
        // 當路由參數變更時更新
        if (BookNumber > 0 && ChapterNumber > 0)
        {
            currentBookNumber = BookNumber;
            currentChapterNumber = ChapterNumber;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            DebugLogService?.Log($"[BibleReadPage] OnAfterRenderAsync firstRender - currentBookNumber: {currentBookNumber}, currentChapterNumber: {currentChapterNumber}", Models.LogLevel.Info);
            
            // 載入設定
            if (SettingsService != null)
            {
                settings = await SettingsService.LoadSettingsAsync();
            }

            // 只有在沒有從 URL 參數或查詢參數初始化時，才從頁面狀態載入
            if (!initializedFromUrl && PageStateService != null)
            {
                DebugLogService?.Log($"[BibleReadPage] 嘗試從頁面狀態載入", Models.LogLevel.Info);
                var state = await PageStateService.LoadReadPageStateAsync();
                if (state.BookNumber > 0)
                {
                    currentBookNumber = state.BookNumber;
                    DebugLogService?.Log($"[BibleReadPage] 從頁面狀態載入 BookNumber: {state.BookNumber}", Models.LogLevel.Info);
                }
                if (state.ChapterNumber > 0)
                {
                    currentChapterNumber = state.ChapterNumber;
                    DebugLogService?.Log($"[BibleReadPage] 從頁面狀態載入 ChapterNumber: {state.ChapterNumber}", Models.LogLevel.Info);
                }
            }
            else
            {
                DebugLogService?.Log($"[BibleReadPage] 跳過頁面狀態載入（initializedFromUrl={initializedFromUrl}）", Models.LogLevel.Info);
            }

            DebugLogService?.Log($"[BibleReadPage] 準備載入章節 - BookNumber: {currentBookNumber}, ChapterNumber: {currentChapterNumber}", Models.LogLevel.Info);
            await LoadChapter();
            StateHasChanged();
        }
    }

    private async Task LoadChapter()
    {
        isLoading = true;

        try
        {
            if (ReadingService != null)
            {
                verses = ReadingService.GetChapterVerses(currentBookNumber, currentChapterNumber);
                chapterTitle = ReadingService.GetChapterTitle(currentBookNumber, currentChapterNumber);
                currentBookName = ReadingService.GetBookName(currentBookNumber);

                // 計算上下章資訊
                var prev = ReadingService.GetPreviousChapter(currentBookNumber, currentChapterNumber);
                hasPreviousChapter = prev.HasValue;
                previousChapterTitle = prev.HasValue 
                    ? ReadingService.GetChapterTitle(prev.Value.BookNumber, prev.Value.ChapterNumber) 
                    : null;

                var next = ReadingService.GetNextChapter(currentBookNumber, currentChapterNumber);
                hasNextChapter = next.HasValue;
                nextChapterTitle = next.HasValue 
                    ? ReadingService.GetChapterTitle(next.Value.BookNumber, next.Value.ChapterNumber) 
                    : null;
            }

            // 儲存頁面狀態
            await SavePageState();

            // 自動加入書籤
            await AddBookmark();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSelectionChanged((int BookNumber, int ChapterNumber) selection)
    {
        currentBookNumber = selection.BookNumber;
        currentChapterNumber = selection.ChapterNumber;
        highlightedVerseNumber = null;
        await LoadChapter();

        // 更新 URL
        UpdateUrl();
    }

    private async Task GoToPreviousChapter()
    {
        if (ReadingService == null) return;

        var prev = ReadingService.GetPreviousChapter(currentBookNumber, currentChapterNumber);
        if (prev.HasValue)
        {
            currentBookNumber = prev.Value.BookNumber;
            currentChapterNumber = prev.Value.ChapterNumber;
            highlightedVerseNumber = null;
            await LoadChapter();
            UpdateUrl();
        }
    }

    private async Task GoToNextChapter()
    {
        if (ReadingService == null) return;

        var next = ReadingService.GetNextChapter(currentBookNumber, currentChapterNumber);
        if (next.HasValue)
        {
            currentBookNumber = next.Value.BookNumber;
            currentChapterNumber = next.Value.ChapterNumber;
            highlightedVerseNumber = null;
            await LoadChapter();
            UpdateUrl();
        }
    }

    private void UpdateUrl()
    {
        NavigationManager?.NavigateTo($"bible/read/{currentBookNumber}/{currentChapterNumber}", replace: true);
    }

    private void ToggleSettings()
    {
        showSettings = !showSettings;
    }

    private async Task OnSettingsChanged(BibleSettings newSettings)
    {
        settings = newSettings;
        if (SettingsService != null)
        {
            await SettingsService.SaveSettingsAsync(settings);
        }
    }

    private async Task SavePageState()
    {
        if (PageStateService != null)
        {
            await PageStateService.SaveReadPageStateAsync(new BibleReadPageState
            {
                BookNumber = currentBookNumber,
                ChapterNumber = currentChapterNumber,
                ScrollPosition = 0
            });
        }
    }

    private async Task AddBookmark()
    {
        if (BookmarkService != null && ReadingService != null)
        {
            var bookName = ReadingService.GetBookName(currentBookNumber);
            await BookmarkService.AddBookmarkAsync(currentBookNumber, bookName, currentChapterNumber);
            
            // 重新載入書籤列表
            await LoadBookmarks();
        }
    }

    private void ToggleBookmarks()
    {
        showBookmarks = !showBookmarks;
        if (showBookmarks && !bookmarks.Any())
        {
            _ = LoadBookmarks();
        }
    }

    private async Task LoadBookmarks()
    {
        if (BookmarkService == null) return;

        isLoadingBookmarks = true;
        StateHasChanged();

        try
        {
            bookmarks = await BookmarkService.LoadBookmarksAsync();
        }
        catch
        {
            // Ignore errors
        }
        finally
        {
            isLoadingBookmarks = false;
            StateHasChanged();
        }
    }

    private async Task OnBookmarkClicked(BibleBookmark bookmark)
    {
        currentBookNumber = bookmark.BookNumber;
        currentChapterNumber = bookmark.ChapterNumber;
        highlightedVerseNumber = null;
        await LoadChapter();
        UpdateUrl();
    }

    private async Task OnBookmarkRemoved(BibleBookmark bookmark)
    {
        if (BookmarkService != null)
        {
            await BookmarkService.RemoveBookmarkAsync(bookmark);
            await LoadBookmarks();
        }
    }

    private async Task OnClearAllBookmarks()
    {
        if (BookmarkService != null)
        {
            await BookmarkService.ClearAllBookmarksAsync();
            bookmarks.Clear();
            StateHasChanged();
        }
    }

    private void ShowExportDialog()
    {
        showExportDialog = true;
    }

    private void CloseExportDialog()
    {
        showExportDialog = false;
    }

    private string GetContainerStyle()
    {
        var bgColor = BibleStyleHelper.GetBackgroundColorHex(settings.BackgroundColor);
        return $"background-color: {bgColor};";
    }

    private async Task OnExportSuccess(string message)
    {
        toastMessage = message;
        showExportDialog = false;
        StateHasChanged();

        // 自動關閉 Toast
        await Task.Delay(3000);
        toastMessage = null;
        StateHasChanged();
    }
}

