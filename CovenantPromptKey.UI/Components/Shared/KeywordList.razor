@namespace CovenantPromptKey.Components.Shared

@using CovenantPromptKey.Models
@using CovenantPromptKey.Services.Interfaces

@inject IDictionaryService DictionaryService

<div class="keyword-list">
    <div class="keyword-list__header">
        <h4 class="keyword-list__title">關鍵字字典</h4>
        <span class="keyword-list__count">@_mappings.Count / @Constants.AppConstants.MaxKeywordCount</span>
    </div>
    
    @if (_isLoading)
    {
        <div class="keyword-list__loading">
            <div class="spinner"></div>
            <span>載入中...</span>
        </div>
    }
    else if (_mappings.Count == 0)
    {
        <div class="keyword-list__empty">
            <svg class="keyword-list__empty-icon" viewBox="0 0 24 24" width="48" height="48">
                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-7-2h2v-4h4v-2h-4V7h-2v4H8v2h4z"/>
            </svg>
            <p>尚無關鍵字映射</p>
            <p class="keyword-list__empty-hint">點擊「新增」按鈕或匯入 CSV 來建立字典</p>
        </div>
    }
    else
    {
        <div class="keyword-list__search">
            <input type="text" 
                   class="keyword-list__search-input" 
                   placeholder="搜尋關鍵字..."
                   @bind="_searchTerm"
                   @bind:event="oninput" />
        </div>
        
        <div class="keyword-list__items">
            @foreach (var mapping in FilteredMappings)
            {
                <div class="keyword-list__item">
                    <div class="keyword-list__item-color" style="background-color: @mapping.HighlightColor"></div>
                    <div class="keyword-list__item-content">
                        <div class="keyword-list__item-keys">
                            <span class="keyword-list__item-sensitive" title="@mapping.SensitiveKey">
                                @TruncateText(mapping.SensitiveKey, 30)
                            </span>
                            <span class="keyword-list__item-arrow">→</span>
                            <span class="keyword-list__item-safe" title="@mapping.SafeKey">
                                @TruncateText(mapping.SafeKey, 30)
                            </span>
                        </div>
                    </div>
                    <div class="keyword-list__item-actions">
                        <button class="keyword-list__btn keyword-list__btn--edit" 
                                title="編輯"
                                @onclick="() => HandleEdit(mapping)">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="keyword-list__btn keyword-list__btn--delete" 
                                title="刪除"
                                @onclick="() => HandleDelete(mapping)">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    /// <summary>
    /// 編輯關鍵字時觸發
    /// </summary>
    [Parameter]
    public EventCallback<KeywordMapping> OnEdit { get; set; }

    /// <summary>
    /// 刪除關鍵字時觸發
    /// </summary>
    [Parameter]
    public EventCallback<KeywordMapping> OnDelete { get; set; }

    private List<KeywordMapping> _mappings = [];
    private string _searchTerm = string.Empty;
    private bool _isLoading = true;

    private IEnumerable<KeywordMapping> FilteredMappings =>
        string.IsNullOrWhiteSpace(_searchTerm)
            ? _mappings
            : _mappings.Where(m =>
                m.SensitiveKey.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                m.SafeKey.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        DictionaryService.OnDictionaryChanged += HandleDictionaryChanged;
        await LoadMappingsAsync();
    }

    private async Task LoadMappingsAsync()
    {
        _isLoading = true;
        try
        {
            _mappings = (await DictionaryService.GetAllAsync()).ToList();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void HandleDictionaryChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadMappingsAsync();
            StateHasChanged();
        });
    }

    private async Task HandleEdit(KeywordMapping mapping)
    {
        await OnEdit.InvokeAsync(mapping);
    }

    private async Task HandleDelete(KeywordMapping mapping)
    {
        await OnDelete.InvokeAsync(mapping);
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..(maxLength - 3)] + "...";
    }

    public void Dispose()
    {
        DictionaryService.OnDictionaryChanged -= HandleDictionaryChanged;
    }
}
