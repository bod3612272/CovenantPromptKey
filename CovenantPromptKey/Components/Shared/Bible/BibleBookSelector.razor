@using CovenantPromptKey.Services.Interfaces

<div class="bible-book-selector">
    <div class="row g-2">
        <div class="col-md-6">
            <label class="form-label">書卷</label>
            <select class="form-select" @bind="selectedBookNumber" @bind:after="OnBookChanged">
                @foreach (var (name, index) in GetBookOptions())
                {
                    <option value="@index">@name</option>
                }
            </select>
        </div>
        <div class="col-md-6">
            <label class="form-label">章節</label>
            <select class="form-select" @bind="selectedChapterNumber" @bind:after="OnChapterChanged">
                @for (int i = 1; i <= ChapterCount; i++)
                {
                    <option value="@i">第 @i 章</option>
                }
            </select>
        </div>
    </div>
    
    @if (ShowQuickAccess)
    {
        <div class="mt-3">
            <div class="btn-group" role="group" aria-label="快捷選擇">
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(1, 1)" title="創世記">創</button>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(19, 1)" title="詩篇">詩</button>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(20, 1)" title="箴言">箴</button>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(40, 1)" title="馬太福音">太</button>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(43, 1)" title="約翰福音">約</button>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(45, 1)" title="羅馬書">羅</button>
                <button type="button" class="btn btn-sm btn-outline-primary" 
                        @onclick="() => SelectBook(66, 1)" title="啟示錄">啟</button>
            </div>
        </div>
    }
</div>

@code {
    [Inject]
    private IBibleReadingService? ReadingService { get; set; }

    [Parameter]
    public int BookNumber { get; set; } = 1;

    [Parameter]
    public int ChapterNumber { get; set; } = 1;

    [Parameter]
    public bool ShowQuickAccess { get; set; } = true;

    [Parameter]
    public EventCallback<(int BookNumber, int ChapterNumber)> OnSelectionChanged { get; set; }

    private int selectedBookNumber;
    private int selectedChapterNumber;
    private int ChapterCount => ReadingService?.GetChapterCount(selectedBookNumber) ?? 1;

    private List<string>? _bookNames;
    private bool _initialized = false;

    protected override void OnInitialized()
    {
        selectedBookNumber = BookNumber > 0 ? BookNumber : 1;
        selectedChapterNumber = ChapterNumber > 0 ? ChapterNumber : 1;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _bookNames = ReadingService?.GetAllBookNames();
            _initialized = true;
            StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        if (BookNumber > 0 && ChapterNumber > 0)
        {
            if (selectedBookNumber != BookNumber || selectedChapterNumber != ChapterNumber)
            {
                selectedBookNumber = BookNumber;
                selectedChapterNumber = ChapterNumber;
            }
        }
    }

    private IEnumerable<(string Name, int Index)> GetBookOptions()
    {
        if (_bookNames == null)
            yield break;

        for (int i = 0; i < _bookNames.Count; i++)
        {
            yield return (_bookNames[i], i + 1);
        }
    }

    private async Task OnBookChanged()
    {
        // 書卷變更時，章節重設為 1
        if (selectedChapterNumber > ChapterCount)
        {
            selectedChapterNumber = 1;
        }
        await NotifyChange();
    }

    private async Task OnChapterChanged()
    {
        await NotifyChange();
    }

    private async Task SelectBook(int bookNumber, int chapterNumber)
    {
        selectedBookNumber = bookNumber;
        selectedChapterNumber = chapterNumber;
        await NotifyChange();
    }

    private async Task NotifyChange()
    {
        await OnSelectionChanged.InvokeAsync((selectedBookNumber, selectedChapterNumber));
    }
}
