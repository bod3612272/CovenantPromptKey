# 功能規格: 互動式關鍵字替換介面

**功能分支**: `001-interactive-keyword-panel`
**建立日期**: 2025-12-03
**狀態**: 草稿
**輸入**: 使用者描述: "幫我用繁體中文 zh-tw 根據 @.github/prompts/spec.prompt.md 裡面的需求撰寫"

## Clarifications

### Session 2025-12-03
- Q: 當使用者已貼上文本並進行勾選後，如果他們不小心刷新或關閉了頁面，應用程式是否應該自動儲存當前的狀態以便後續還原？ → A: 是，儲存工作階段狀態（例如使用瀏覽器的 sessionStorage），以便在頁面重新載入時還原。
- Q: 在系統偵測到關鍵字之後，如果使用者回頭去編輯左側的原文內容，此時系統應如何回應？ → A: 允許編輯，原文區域旁會出現一個「重新偵測」按鈕，讓使用者在修改完畢後手動觸發更新。
- Q: 使用者將如何管理他們的關鍵字字典（例如新增、刪除或修改關鍵字）？ → A: 兩種方式都支援：提供手動管理的表單，並額外提供批次匯入/匯出的功能。
- Q: 關於無障礙設計（Accessibility, a11y），我們應該設定什麼樣的目標？ → A: 現階段這不是優先事項，可以稍後再考慮。
- Q: 規格中的成功標準 SC-004 提到要達到「95% 的首次使用者成功率」。我們該如何衡量這個指標？ → A: 這不是優先事項。暫時可以先從成功標準中移除 SC-004 這個指標。
- Q: 關鍵字字典的匯入/匯出應使用何種格式？ → A: 應使用 CSV 格式，以方便使用者透過 Excel 或其他試算表軟體編輯。
- Q: 當使用者匯入 CSV 檔案時，如果檔案格式不符或包含特殊字元，系統應如何處理？ → A: 系統必須進行防呆處理。應驗證檔案格式與內容，並在發生錯誤時提供清晰、可操作的錯誤提示，拒絕匯入有問題的檔案。
- Q: 當不同的 `SensitiveKey` 對應到同一個 `SafeKey` 時（例如 A->C, B->C），還原時的行為應如何？ → A: 禁止與驗證：不允許使用者儲存此類設定。系統會驗證字典，若使用者試圖將新的機敏詞對應到一個已被使用的安全替代字，則會顯示錯誤。
- Q: 關於系統的可觀測性（Observability），當伺服器端發生錯誤時，我們期望系統如何記錄這些資訊？ → A: 不需日誌 (No Logging)。此功能不要求任何伺服器端日誌，將完全依賴瀏覽器開發者工具中的錯誤和使用者的手動回報。

## 使用者場景與測試 *(必要)*

### 使用者故事 1 - 核心替換流程 (優先度: P1)

身為開發者，我希望在不離開應用程式的情況下，安全地對機敏資訊進行遮罩。我將一段包含多個關鍵字的文字貼入系統，系統會立即在一個獨立的面板中列出所有偵測到的關鍵字，並在原文中進行高亮標示。我可以透過中間的控制面板，快速勾選或取消勾選想要替換的關鍵字。點擊「執行替換」後，系統會彈出一個確認對話框，顯示即將替換與跳過的內容。確認後，右側的結果區會顯示僅替換了所選關鍵字的安全文本。

**優先度理由**: 此為 v1.1.0 的核心功能，提供了精準的互動式控制，解決了舊版全自動替換可能誤傷內容的問題，是本次改版最主要的價值所在。

**獨立測試**: 可以透過貼上一段包含已知關鍵字的文本來獨立測試。驗證系統是否能正確偵測、讓使用者選擇、並僅替換選擇的關鍵字，最終產出符合預期的結果，並顯示正確的統計資訊。

**驗收場景**:

1.  **假設** 使用者有一段包含 "武科電" 和 "Eason" 的文本，且兩者都在字典中。
    **當** 使用者貼上文本，並在關鍵字面板中僅勾選 "武科電" 後，點擊「執行替換」並確認。
    **那麼** 系統應在結果區顯示替換了 "武科電" (例如 "T-Company") 但保留 "Eason" 的文本，並顯示統計資訊 "已替換 1 項, 跳過 1 項"。

2.  **假設** 使用者的字典是空的。
    **當** 使用者貼上任何文本。
    **那麼** 關鍵字控制面板應顯示「未偵測到關鍵字」，「執行替換」按鈕應為禁用狀態，並提示使用者 "請先在設定中新增關鍵字"。

3.  **假設** 使用者已偵測到數個關鍵字。
    **當** 使用者點擊「取消」按鈕並在確認對話框中確認。
    **那麼** 系統應清空所有偵測結果，並將原文區、控制面板、結果區全部重置為初始狀態。

---

### 使用者故事 2 - 詳細互動與定位 (優先度: P2)

在處理長文件時，我需要快速了解每個關鍵字的分布情況並進行定位。系統不僅在控制面板中顯示每個關鍵字的出現次數，還能展開列表，顯示每個關鍵字出現的具體行號。點擊行號標記，左側的原文檢視區會平滑滾動到該關鍵字的位置並提供短暫的視覺回饋 (例如閃爍高亮)，方便我進行上下文確認。此外，我也可以直接點擊原文中高亮的關鍵字來切換其替換狀態。

**優先度理由**: 提升處理長文本時的可用性與效率，讓使用者能快速在上下文和控制面板之間切換，做出更準確的判斷。

**獨立測試**: 使用一段長文本（例如超過 50 行）並包含多個重複的關鍵字進行測試。驗證計數是否正確、位置標記是否能正確觸發平滑滾動與視覺回饋，以及在原文中點擊關鍵字是否能同步更新控制面板的狀態。

**驗收場景**:

1.  **假設** 文本的第 5 行和第 50 行都有 "ProjectX"。
    **當** 使用者在關鍵字控制面板點擊 "ProjectX" 的第 50 行位置標記。
    **那麼** 左側的原文檢視區應平滑滾動到第 50 行，且對應的 "ProjectX" 應有短暫的視覺提示。

2.  **假設** 原文中的關鍵字 "Eason" 預設為「選擇替換」狀態。
    **當** 使用者直接點擊原文中高亮的 "Eason"。
    **那麼** 該關鍵字的視覺樣式應變為「不選擇替換」，控制面板中對應的勾選框應被取消，並顯示一個短暫的提示訊息，例如 "已取消替換 Eason"。

---

### 使用者故事 3 - 上下文語境警示 (優先度: P3)

我擔心關鍵字替換會破壞連貫的中文詞組。為了避免這種情況，當系統偵測到一個關鍵字的前後緊鄰著其他中文字元時，它應在關鍵字控制面板的該項目旁顯示一個警示圖示 (⚠️)，提醒我此處可能存在語境問題。關鍵字預設仍為「選擇替換」，但我可以根據警示手動取消勾選。

**優先度理由**: 在簡化判斷邏輯的同時，依然提供了一層重要的安全網，讓使用者能掌控最終替換結果，避免破壞原文語意。

**獨立測試**: 構造包含部分匹配和完全匹配的文本進行測試。例如，字典中有 "武科電"，文本中包含 "武科電的規範" 和 "武科電路板"。驗證在這兩種情況下，"武科電" 是否都會被標記警示圖示，但預設仍為勾選替換狀態。

**驗收場景**:

1.  **假設** 字典中有關鍵字 "AI"，且文本為 "This is a train"。
    **當** 系統進行偵測。
    **那麼** "train" 中的 "ai" 不應被偵測為關鍵字。

2.  **假設** 字典中有關鍵字 "武科電"，且文本為 "武科電路板設計"。
    **當** 系統進行偵測。
    **那麼** 控制面板應將此處的 "武科電" 標記一個警示圖示 (⚠️)，但其替換狀態預設仍為「選擇」。

---

### 使用者故事 4 - 關鍵字字典管理 (優先度: P1)

身為開發者，我需要一個方便的介面來管理我的關鍵字字典。我希望可以手動新增、修改或刪除單一的關鍵字映射，也希望能將整個字典匯出備份，或從備份檔匯入，以便在不同裝置間同步我的設定。

**優先度理由**: 關鍵字字典是此應用的核心與基礎，若無有效的管理方式，所有替換功能都無法運作。提供匯入/匯出功能可大幅提升實用性與資料可攜性。

**驗收場景**:

1.  **假設** 使用者在關鍵字管理介面。
    **當** 使用者填寫表單（機敏詞、替代詞、顏色）並儲存。
    **那麼** 系統應成功新增一筆關鍵字映射，並可在主替換介面中被偵測到。

2.  **假設** 使用者有數筆已設定的關鍵字。
    **當** 使用者點擊「匯出」按鈕。
    **那麼** 瀏覽器應下載一個包含所有關鍵字資料的 CSV 檔案。

3.  **假設** 使用者字典為空。
    **當** 使用者選擇一個格式正確的關鍵字 CSV 檔案並執行「匯入」。
    **那麼** 檔案中的所有關鍵字應被新增至系統中，並可供使用。

4.  **假設** 使用者選擇一個格式錯誤（例如欄位數量不符）或包含無效字元（例如未封閉的引號）的 CSV 檔案。
    **當** 使用者執行「匯入」。
    **那麼** 系統應拒絕匯入，並顯示一個清晰的錯誤訊息，例如「匯入失敗：檔案在第 X 行格式有誤，請檢查後再試。」

5.  **假設** 字典中已存在一個映射 "武科電" -> "T-Company"。
    **當** 使用者試圖新增另一個映射 "Wukeden" -> "T-Company"。
    **那麼** 系統應拒絕儲存，並顯示一個錯誤訊息，例如「儲存失敗：替代詞 'T-Company' 已被使用，請為 'Wukeden' 提供一個唯一的替代詞。」

6.  **假設** 使用者試圖新增一個常見的程式語言保留字（例如 "public", "def", "final" 等）作為機敏詞。
    **當** 使用者儲存該關鍵字時。
    **那麼** 系統應拒絕儲存，並顯示一個錯誤訊息，例如「儲存失敗：'public' 是受保護的程式語言關鍵字，無法作為替換目標。」

7.  **假設** 使用者試圖新增一個簡短的、且是一個常見程式語言關鍵字子字串的詞（例如 "pub"）作為機敏詞。
    **當** 使用者儲存該關鍵字時。
    **那麼** 系統應彈出一個確認對話框，提示「警告：'pub' 是程式語言關鍵字 'public' 的一部分，新增它可能會導致非預期的程式碼替換。您確定要新增嗎？」，並提供「確定新增」和「取消」的選項。

---

### 使用者故事 5 - AI 回應還原 (優先度: P2)

身為開發者，當我從 AI 模型收到包含遮罩關鍵字（例如 "T-Company"）的回應後，我希望能將這段文本貼回應用程式，讓系統自動將這些遮罩詞彙還原成原始的機敏關鍵字（例如 "武科電"），以便我能得到最終的、完整的內容。

**優先度理由**: 此功能完成了整個「去識別化 -> AI 互動 -> 還原」的閉環工作流程，是實現「安全對話中介層」核心價值的關鍵一環，讓工具不僅能送出問題，還能取回可用的答案。

**獨立測試**: 可以透過準備一段包含已知安全替代字 (`SafeKey`) 的文本來獨立測試。將此文本貼入還原功能區，驗證系統是否能依據字典反向查找，並正確地將所有安全替代字還原為其對應的機敏關鍵字。

**驗收場景**:

1.  **假設** AI 的回應文本為 "我們已收到 T-Company 關於 Project_Omega 的最新進度報告。"
    **當** 使用者將此文本貼入還原區並執行還原。
    **那麼** 結果區應顯示 "我們已收到 武科電 關於 ProjectX 的最新進度報告。"

2.  **假設** 文本中包含的 "User_C" 不在任何關鍵字映射的 `SafeKey` 中。
    **當** 使用者執行還原。
    **那麼** "User_C" 應保持不變，且系統應提示 "已完成還原，共處理 N 個關鍵字"。

---

### 邊界案例

-   **遮罩流程**:
    -   當關鍵字是另一個關鍵字的子字串時 (如 "Project" 和 "ProjectX")，系統應優先匹配最長的關鍵字 ("ProjectX")，避免重複標記。
    -   當關鍵字出現在 Markdown **URL** 中時，系統應保護該區域，不進行偵測與替換。
    -   當關鍵字出現在 Markdown **程式碼區塊** 中時，系統**應進行偵測與替換**，但必須採用「僅限全單詞匹配 (whole-word-only)」模式，以避免破壞程式碼語法。例如，若關鍵字為 "task"，它應替換 "run(task)" 中的 "task"，但不應替換 "TaskRunner" 中的 "Task"。
    -   當使用者在執行期間於設定頁面更新關鍵字字典時，主介面應能觸發重新偵測，並應用最新字典。
    -   當處理包含特殊 Unicode 字元 (如 Emoji) 的文本時，系統應能正確處理，不影響偵測邏輯。
    -   當匯入的 CSV 檔案內容損毀或格式不符時，系統應能優雅地處理錯誤，避免應用程式崩潰，並提供有意義的錯誤回饋。
-   **還原流程**:
    -   當 AI 回應中包含與 `SafeKey` 相同的詞，但並非由本工具產生時，系統仍會進行還原。此為預期行為，因為無法區分其來源。
    -   當不同的 `SensitiveKey` 對應到同一個 `SafeKey` 時（例如 A->C, B->C），此為不允許的設定。系統會在使用者新增、修改或匯入關鍵字時進行驗證，防止這種情況發生，以確保還原行為的唯一性與準確性。

## 需求 *(必要)*

### 功能需求

-   **FR-001**: 系統必須提供一個三欄式佈局（原文 / 控制面板 / 結果），且各欄可獨立滾動。
-   **FR-002**: 系統必須在控制面板列出所有偵測到的關鍵字、出現次數及替換狀態。
-   **FR-003**: 使用者必須能透過點擊控制面板或原文高亮標記來切換單一關鍵字的替換狀態。
-   **FR-004**: 系統必須在原文區域根據「選擇/未選擇」狀態提供不同的視覺標記。
-   **FR-005**: 系統必須在執行替換前顯示一個確認對話框，內容包含替換和跳過的項目統計。
-   **FR-006**: 系統必須僅替換使用者已明確勾選的關鍵字。
-   **FR-007**: 系統必須保護 Markdown 的 URL 不受替換影響。
-   **FR-008**: 關鍵字控制面板必須包含一個「取消」按鈕，用於清空當前偵測結果並重置介面。
-   **FR-009**: 控制面板必須提供「全選」、「全不選」、「反選」的批次操作功能。
-   **FR-010**: 系統必須提供快捷的剪貼簿整合按鈕，如「貼上並偵測」和「複製結果」。
-   **FR-011**: 系統必須提供一個即時統計儀表板，顯示偵測總數、已選數量、警示數量等。
-   **FR-012**: 系統必須檢查關鍵字前後是否緊鄰中文字元，並在控制面板顯示警示圖示。
-   **FR-013**: 控制面板中的關鍵字列表應支援位置展開/收合，以顯示或隱藏其在原文中的所有行號。
-   **FR-014**: 點擊行號應觸發原文區域平滑滾動至對應位置，並提供視覺回饋。
-   **FR-015**: 核心操作應支援鍵盤快捷鍵（如 Ctrl+V 貼上, Ctrl+A 全選）。
-   **FR-016**: 系統必須使用瀏覽器的 `sessionStorage` 自動儲存使用者當前的工作階段（包含原文、關鍵字偵測結果與勾選狀態），以便在使用者刷新或重新開啟頁面時能還原，避免資料遺失。
-   **FR-017**: 當使用者在關鍵字偵測後編輯原文時，系統應保持原文區域為可編輯狀態，並在旁顯示一個「重新偵測」按鈕。點擊該按鈕將使用更新後的文本觸發一次新的偵測流程。
-   **FR-018**: 系統必須提供一個獨立的「設定」或「關鍵字管理」頁面。
-   **FR-019**: 在管理頁面中，使用者必須能夠以表單形式手動新增、檢視、編輯和刪除關鍵字映射 (`KeywordMapping`)。
-   **FR-020**: 系統必須提供將當前所有關鍵字字典匯出為一個 CSV 檔案的功能。
-   **FR-021**: 系統必須提供從一個格式相符的 CSV 檔案匯入關鍵字的功能，並提供「合併」或「覆蓋」現有字典的選項。
-   **FR-022**: 系統在執行 CSV 匯入時，必須驗證檔案的結構與內容。驗證應至少包含：欄位數量是否正確、是否包含非預期的特殊字元或未封閉的引號。若驗證失敗，系統必須終止匯入並向使用者顯示具體的錯誤訊息與位置（如行號）。
-   **FR-023**: 系統必須提供一個用於貼上 AI 回應並執行還原的功能區。
-   **FR-024**: 還原功能必須能夠反向查找字典，將所有匹配的安全替代字 (`SafeKey`) 準確地還原為其對應的原始機敏關鍵字 (`SensitiveKey`)。
-   **FR-025**: 還原過程必須完整保留文本的原始格式（如換行、Markdown 語法），不得因還原操作而破壞結構。
-   **FR-026**: 在新增、修改或匯入關鍵字時，系統必須驗證 `SafeKey` 的唯一性。如果使用者試圖將一個 `SensitiveKey` 映射到一個已經被其他 `SensitiveKey` 使用的 `SafeKey`，系統必須阻止該操作並顯示明確的錯誤訊息。
-   **FR-027**: 系統在處理 Markdown 程式碼區塊內的內容時，必須啟用「僅限全單詞匹配 (whole-word-only)」的偵測模式。
-   **FR-028**: 系統必須禁止使用者新增常見的程式語言關鍵字（如 C# 的 'public', 'namespace'; Python 的 'def', 'import'; Java 的 'public', 'final' 等）至字典中，並在使用者試圖新增或匯入時提供明確的錯誤提示。
-   **FR-029**: 當使用者新增或匯入的關鍵字是某個常見程式語言關鍵字的子字串（substring），且該關鍵字長度較短（例如少於4個字元）時，系統不應直接拒絕，而是必須顯示一個警告對話框，向使用者說明潛在風險，並要求使用者明確確認後才能新增。

### 關鍵實體

-   **KeywordMapping (關鍵字映射)**: 代表一個機敏關鍵字及其對應的安全替代字和高亮顏色。屬性包括：`SensitiveKey`, `SafeKey`, `ColorHex`。
-   **KeywordOccurrence (關鍵字出現記錄)**: 代表在文本中偵測到的單一類型關鍵字的集合。屬性包括：原始關鍵字、安全替代字、高亮顏色、所有出現位置的索引列表 (`Positions`)、是否被選擇 (`IsSelected`)、出現次數 (`Count`)、以及是否有上下文警示 (`HasContextWarning`)。
-   **ProtectedRange (受保護區域)**: 代表文本中不應被處理的區域（如程式碼塊、URL）。屬性包括：起始位置 `Start`、結束位置 `End`、區域類型 `Type`。

## 成功標準 *(必要)*

### 可衡量的成果

-   **SC-001**: 對於 1,000 字的標準文本，從貼上到完成偵測並渲染UI的時間應低於 200 毫秒。
-   **SC-002**: 使用者與UI互動（如勾選、點擊）的響應時間應低於 150 毫秒。
-   **SC-003**: 當處理包含大量（如 >1,000 個）匹配項的長文本時，UI 應保持流暢，不應凍結或卡頓。
-   **SC-004**: 還原功能處理 1,000 字文本的時間應低於 100 毫秒。
-   **SC-005**: 系統提供的所有錯誤或提示訊息都應清晰且包含可操作的建議。
-   **SC-006**: 系統的介面佈局在主流瀏覽器（最新版的 Chrome, Edge, Firefox）及常見螢幕解析度（1366px 至 4K）下皆不可破損。
-   **SC-007**: 所有文本處理必須在使用者端完成，不得有任何原始或替換後文本傳輸至外部伺服器。

### 暫不考慮 (Non-Goals)
- **Accessibility (a11y)**: 本版本暫不以符合特定無障礙標準（如 WCAG）為目標。基礎的可用性將透過語意化 HTML 來達成，但完整的鍵盤導覽與 ARIA 支援將在未來版本中考慮。
- **伺服器端日誌 (Server-side Logging)**: 本版本不要求對伺服器端的操作（如錯誤、效能、使用情況）進行任何形式的記錄。所有問題排查將依賴於終端使用者的回報和瀏覽器開發者工具。


備註:
Blazor 的側邊欄選單的項目為 
1. "替換與還原" (Replace & Restore)
2. "設定" (Settings) -> 包含關鍵字管理 ( 匯入/匯出功能、新增/編輯/刪除關鍵字 )
3. "說明" (Help)
4. "關於" (About)
5. "回報問題" (Report Issue)
6. "版本紀錄" (Changelog)

程式開啟時要自動找到沒被占用的 TCP/IP 的 port 來啟動伺服器。
且必須立刻開啟預設瀏覽器並導向到該 port 的首頁。
- **自動選單導向**: 當應用程式啟動時，應自動打開預設瀏覽器並導向到主功能頁面 "替換與還原"。
- **動態 Port 偵測**: 應用程式在啟動時應自動偵測並選擇一個未被占用的 TCP/IP port 來啟動內建伺服器，確保不會與其他應用程式發生衝突。
- **跨平台相容性**: 應用程式目前只要能在 Windows 作業系統上穩定運行即可，無需支援 macOS 或 Linux。

