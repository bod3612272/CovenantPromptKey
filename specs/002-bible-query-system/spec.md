# Feature Specification: 聖經查詢系統 (Bible Query System)

**Feature Branch**: `2-bible-query-system`  
**Created**: 2025-12-05  
**Status**: Draft  
**Input**: 建立聖經查詢系統，包含聖經查詢、聖經閱讀及聖經遊戲三個主要功能，整合至現有 CovenantPromptKey 網頁應用程式

## Overview

本功能為 CovenantPromptKey 網頁應用程式新增一個「聖經」子系統，提供使用者聖經查詢、閱讀及遊戲互動體驗。系統將利用現有的 BibleData DLL 提供聖經經文資料，並透過 Web Storage API 儲存使用者設定與狀態資訊。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 聖經關鍵字搜尋 (Priority: P1)

使用者希望透過輸入關鍵字快速找到相關的聖經經文，以便進行查經或靈修時參考。

**Why this priority**: 關鍵字搜尋是聖經查詢系統最核心的功能，能讓使用者快速定位所需經文，為其他功能奠定基礎。

**Independent Test**: 使用者可透過輸入關鍵字（如「愛」）並獲得相關經文列表來獨立測試此功能，無需依賴閱讀或遊戲功能。

**Acceptance Scenarios**:

1. **Given** 使用者位於聖經查詢頁面，**When** 輸入關鍵字「愛」並執行搜尋，**Then** 系統顯示包含「愛」的經文列表，每筆結果顯示書卷、章節及節數
2. **Given** 使用者輸入關鍵字，**When** 輸入過程中系統開始即時搜尋，**Then** 系統顯示即時搜尋建議，毋須等待使用者按下搜尋按鈕
3. **Given** 使用者輸入多個關鍵字（如「神 愛」），**When** 執行搜尋，**Then** 系統回傳同時包含所有關鍵字的經文
4. **Given** 搜尋結果超過單頁顯示數量，**When** 使用者查看結果，**Then** 系統提供分頁功能供使用者瀏覽
5. **Given** 使用者執行搜尋後，**When** 搜尋結果顯示，**Then** 結果依相關性排序呈現

---

### User Story 2 - 聖經章節閱讀 (Priority: P1)

使用者希望選擇特定書卷與章節進行逐節閱讀聖經，並能快速導航至不同章節。

**Why this priority**: 聖經閱讀是使用者最基本且頻繁的需求，與搜尋功能同為核心功能。

**Independent Test**: 使用者可選擇任一書卷與章節進行閱讀，並透過導航按鈕切換章節來獨立測試此功能。

**Acceptance Scenarios**:

1. **Given** 使用者位於聖經閱讀頁面，**When** 從書卷目錄選擇「創世記」第 1 章，**Then** 系統顯示該章所有經文，每節一行並標示節數
2. **Given** 使用者正在閱讀某章節，**When** 點選「下一章」按鈕，**Then** 系統導航至下一章並顯示內容
3. **Given** 使用者正在閱讀某章節，**When** 點選「上一章」按鈕，**Then** 系統導航至上一章並顯示內容
4. **Given** 使用者欲快速跳轉至特定章節，**When** 直接輸入章節號碼並確認，**Then** 系統跳轉至指定章節
5. **Given** 使用者閱讀經文後離開頁面，**When** 再次回到聖經閱讀頁面，**Then** 系統自動恢復至先前閱讀的書卷與章節

---

### User Story 3 - 閱讀設定自訂 (Priority: P2)

使用者希望自訂經文顯示的字形、字體大小、顏色及背景，以符合個人閱讀習慣與舒適度。

**Why this priority**: 提升使用者閱讀體驗的重要功能，但非核心功能，可於基本閱讀功能完成後實作。

**Independent Test**: 使用者可於設定中調整各項顯示選項，並立即於經文顯示區域看到效果。

**Acceptance Scenarios**:

1. **Given** 使用者位於聖經查詢或閱讀頁面，**When** 開啟顯示設定，**Then** 系統顯示字形、字體大小、文字顏色及背景顏色選項
2. **Given** 使用者選擇「標楷體」字形，**When** 設定變更後，**Then** 經文立即以標楷體顯示
3. **Given** 使用者調整字體大小為 18px，**When** 設定變更後，**Then** 經文字體大小立即調整為 18px
4. **Given** 使用者選擇夜間模式，**When** 設定變更後，**Then** 背景變為黑色、文字變為白色
5. **Given** 使用者關閉網頁後再次開啟，**When** 進入聖經相關頁面，**Then** 系統自動套用先前儲存的顯示設定

---

### User Story 4 - 書籤管理 (Priority: P2)

使用者希望系統自動記錄最近閱讀的經文，方便下次快速訪問。

**Why this priority**: 提升使用者便利性的輔助功能，可於核心功能完成後實作。

**Independent Test**: 使用者閱讀經文後，可於書籤列表查看最近閱讀記錄並點選快速跳轉。

**Acceptance Scenarios**:

1. **Given** 使用者閱讀某章節經文，**When** 完成閱讀或切換至其他章節，**Then** 系統自動將該章節加入書籤列表
2. **Given** 書籤列表已有 10 筆記錄，**When** 使用者閱讀新章節產生第 11 筆記錄，**Then** 系統移除最舊的記錄，保持列表上限 10 筆
3. **Given** 使用者查看書籤列表，**When** 點選某筆書籤記錄，**Then** 系統跳轉至該書籤對應的書卷與章節

---

### User Story 5 - 經文導出 (Priority: P2)

使用者希望將選定的經文導出為 Markdown 格式，方便分享或保存於其他平台。

**Why this priority**: 實用的延伸功能，讓使用者能將經文用於其他用途，但非核心閱讀體驗。

**Independent Test**: 使用者可選擇經文範圍與導出格式，並獲得格式化的 Markdown 文字。

**Acceptance Scenarios**:

1. **Given** 使用者選擇導出馬可福音第 1 章 1-3 節，**When** 選擇風格 1 並執行導出，**Then** 系統產生格式為「(馬可福音 1:1) 經文內容」的 Markdown 文字
2. **Given** 使用者選擇導出經文，**When** 選擇風格 2 並執行導出，**Then** 系統產生格式為「書卷名 ( 第 X 章 Y ~ Z 節 )」標題加逐行經文的 Markdown 文字
3. **Given** 使用者選擇導出經文，**When** 選擇風格 3 並執行導出，**Then** 系統產生格式為「《書卷名》」標題加連續經文段落的 Markdown 文字
4. **Given** 使用者設定導出選項，**When** 勾選「包含書卷標題」，**Then** 導出結果包含書卷標題；反之則不包含
5. **Given** 使用者選擇導出多本書卷，**When** 勾選「一本書一個檔案」並選擇風格 2，**Then** 系統產生多個 .md 檔案，每本書卷一個檔案，檔案內容依風格 2 格式呈現
6. **Given** 使用者選擇導出整本聖經，**When** 勾選「一本書一個檔案」，**Then** 系統產生 66 個 .md 檔案（或所選範圍內的書卷數量），檔名以書卷名稱命名

---

### User Story 6 - 經文猜猜遊戲 (Priority: P3)

使用者希望透過遊戲方式熟悉聖經經文的出處，增進對聖經的認識。

**Why this priority**: 娛樂性質的延伸功能，可於核心查詢與閱讀功能完成後實作。

**Independent Test**: 使用者可開始遊戲、回答 10 題問題並查看分數與歷史記錄。

**Acceptance Scenarios**:

1. **Given** 使用者進入經文猜猜遊戲，**When** 開始新遊戲，**Then** 系統隨機選取一段經文並顯示 4 個書卷選項供選擇
2. **Given** 使用者看到經文與選項，**When** 選擇正確的書卷，**Then** 系統顯示答對提示並記錄得分
3. **Given** 使用者選擇錯誤的書卷，**When** 確認答案，**Then** 系統顯示正確答案
4. **Given** 使用者完成 10 題，**When** 遊戲結束，**Then** 系統顯示本次分數、歷史最高分及最近 5 次遊戲記錄
5. **Given** 使用者查看遊戲記錄，**When** 選擇清除記錄，**Then** 系統清除所有遊戲歷史資料

---

### User Story 7 - 側邊選單導航 (Priority: P1)

使用者希望從網頁左側選單輕鬆存取聖經相關功能，並能快速切換各子功能。

**Why this priority**: 作為進入所有聖經功能的入口，為使用者體驗的基礎架構。

**Independent Test**: 使用者可於側邊選單看到「聖經」選項，展開後可點選子選項進入對應頁面。

**Acceptance Scenarios**:

1. **Given** 使用者位於任何頁面，**When** 查看左側導航選單，**Then** 可見「聖經」主選項
2. **Given** 使用者點選「聖經」主選項，**When** 選單展開，**Then** 顯示「聖經查詢」、「聖經閱讀」及「聖經遊戲」三個子選項
3. **Given** 使用者點選「聖經查詢」子選項，**When** 頁面載入，**Then** 系統顯示聖經查詢功能頁面
4. **Given** 使用者位於聖經主頁面，**When** 查看頁面上方，**Then** 子選項以清晰字體和適當間距呈現於頁面最上方

---

### Edge Cases

- 若使用者輸入的關鍵字未找到任何經文，系統如何回應？顯示「查無結果」訊息並建議調整關鍵字
- 若使用者嘗試導航至不存在的章節（如創世記第 100 章），系統如何處理？顯示錯誤訊息並建議有效範圍
- 若使用者在遊戲進行中關閉頁面，遊戲進度如何處理？該局遊戲不計入記錄，下次重新開始
- 若 Web Storage 已滿，系統如何處理設定儲存？顯示提示訊息並建議清理儲存空間
- 若使用者快速連續輸入搜尋關鍵字，系統如何處理？實作防抖動機制，避免過度查詢

## Requirements *(mandatory)*

### Functional Requirements

#### 導航與架構

- **FR-001**: 系統 MUST 於左側導航選單新增「聖經」主選項，展開後顯示「聖經查詢」、「聖經閱讀」及「聖經遊戲」三個子選項
- **FR-002**: 系統 MUST 於聖經主頁面上方以清晰字體和適當間距顯示子功能選項，方便使用者辨識與切換
- **FR-003**: 系統 MUST 在使用者點選子選項後載入對應的功能頁面

#### 聖經查詢功能

- **FR-010**: 系統 MUST 支援使用者輸入關鍵字進行經文搜尋，回傳包含該關鍵字的經文列表
- **FR-011**: 系統 MUST 於搜尋結果中顯示經文所在的書卷、章節及節數
- **FR-012**: 系統 MUST 支援模糊搜尋功能
- **FR-013**: 系統 MUST 支援多關鍵字搜尋功能（AND 邏輯）
- **FR-014**: 系統 MUST 提供即時搜尋建議，使用者輸入時即時顯示相關經文
- **FR-015**: 系統 MUST 將搜尋結果依相關性排序
- **FR-016**: 系統 MUST 提供搜尋結果分頁功能
- **FR-017**: 系統 MUST 提供經文自動換行選項

#### 聖經閱讀功能

- **FR-020**: 系統 MUST 提供書卷目錄供使用者選擇書卷與章節進行閱讀
- **FR-021**: 系統 MUST 以一行一句格式顯示經文，並標示節數
- **FR-022**: 系統 MUST 於閱讀頁面頂部顯示書卷名稱與章數
- **FR-023**: 系統 MUST 提供上一章與下一章導航按鈕
- **FR-024**: 系統 MUST 支援章節跳轉功能，使用者可直接輸入章節號碼跳轉
- **FR-025**: 系統 MUST 自動記錄使用者閱讀的經文為書籤，保留最近 10 筆記錄
- **FR-026**: 使用者 MUST 能透過書籤快速訪問先前閱讀的經文

#### 顯示設定

- **FR-030**: 系統 MUST 提供字形選擇：標楷體、微軟正黑體
- **FR-031**: 系統 MUST 提供字體大小調整，範圍從 12px 至 24px
- **FR-032**: 系統 MUST 提供文字顏色選擇：全黑、深灰(#333333)、淺灰(#666666)
- **FR-033**: 系統 MUST 提供背景顏色選擇：白色、米色(#FFF8DC)、淺灰(#F5F5F5)、淺綠(#F0FFF0)、夜間模式(背景 #000000、文字 #FFFFFF)
- **FR-034**: 系統 MUST 於使用者切換至聖經相關頁面時自動載入並套用先前儲存的顯示設定

#### 導出功能

- **FR-040**: 系統 MUST 支援將選定經文導出為 Markdown 格式
- **FR-041**: 系統 MUST 提供導出經文範圍設定：單一章節、多個章節或整本書卷
- **FR-042**: 系統 MUST 提供「包含書卷標題」勾選選項
- **FR-043**: 系統 MUST 提供三種導出風格供選擇：
  - 風格 1：每節前加「(書卷 章:節)」格式
  - 風格 2：標題顯示「書卷 ( 第 X 章 Y ~ Z 節 )」，經文逐行顯示
  - 風格 3：標題顯示「《書卷》 ( 第 X 章 Y ~ Z 節 )」，經文連續顯示
- **FR-044**: 系統 MUST 提供「一本書一個檔案」勾選選項，啟用時將每本書卷導出為獨立的 .md 檔案
- **FR-045**: 系統 MUST 於「一本書一個檔案」模式下，以書卷名稱作為檔案名稱（如「創世記.md」、「出埃及記.md」）
- **FR-046**: 系統 MUST 於「一本書一個檔案」模式下，仍可選擇風格 1、2 或 3 作為各檔案的內文格式

#### 聖經遊戲功能

- **FR-050**: 系統 MUST 提供「經文猜猜遊戲」，每輪 10 題
- **FR-051**: 系統 MUST 於每題隨機選取一段經文，並提供 4 個書卷選項供使用者選擇
- **FR-052**: 系統 MUST 於遊戲結束後顯示正確答案並提供重新挑戰選項
- **FR-053**: 系統 MUST 記錄使用者遊戲分數，顯示歷史最高分及最近 5 次遊戲記錄
- **FR-054**: 系統 MUST 提供遊戲記錄查看與清除功能
- **FR-055**: 系統 MUST 於「遊戲 2」位置顯示「敬請期待，歡迎提供新的遊戲點子給我」

#### 狀態管理

- **FR-060**: 系統 MUST 使用 Web Storage API 儲存使用者設定與書籤資料（沿用 CovenantPromptKey 現有方式）
- **FR-061**: 系統 MUST 記憶每個聖經頁面的狀態（如目前章節、最後搜尋關鍵字），直至程式重新啟動
- **FR-062**: 系統 MUST 於使用者返回聖經頁面時恢復先前狀態

### Key Entities

- **BibleSettings（聖經設定）**: 儲存使用者的顯示偏好設定，包含字形、字體大小、文字顏色、背景顏色、自動換行等屬性
- **Bookmark（書籤）**: 記錄使用者閱讀的經文位置，包含書卷、章節、時間戳記等屬性，上限 10 筆
- **GameRecord（遊戲記錄）**: 記錄遊戲分數與時間，包含分數、遊戲時間、答題詳情等屬性
- **PageState（頁面狀態）**: 記憶各聖經頁面的當前狀態，於工作階段期間維持

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可於 2 秒內完成關鍵字搜尋並看到結果
- **SC-002**: 即時搜尋建議於使用者停止輸入後 300 毫秒內顯示
- **SC-003**: 使用者可於 3 次點擊內從任何頁面導航至聖經閱讀特定章節
- **SC-004**: 95% 的使用者能於首次使用時成功完成經文搜尋任務
- **SC-005**: 顯示設定變更後立即反映於經文顯示區域，無需頁面重新載入
- **SC-006**: 書籤功能正確保留最近 10 筆閱讀記錄
- **SC-007**: 遊戲記錄正確儲存並可完整呈現歷史最高分及最近 5 次記錄
- **SC-008**: 經文導出功能產生正確格式的 Markdown 文字，可直接複製使用
- **SC-009**: 頁面狀態於工作階段期間正確維持，使用者返回時可無縫繼續

## Assumptions

- 系統將使用現有的 BibleData DLL 提供合和本新舊約聖經經文資料
- 使用者的瀏覽器支援 Web Storage API（localStorage/sessionStorage）
- 系統目前僅支援繁體中文（合和本）聖經版本
- 即時搜尋採用防抖動（debounce）機制，預設延遲 200-300 毫秒
- 顯示設定使用 localStorage 儲存，頁面狀態使用 sessionStorage 儲存
- 遊戲 2 為預留位置，不在本功能範圍內實作

## Out of Scope

- 其他語言版本的聖經（如英文、簡體中文）
- 聖經註釋或研經資料
- 使用者帳號系統或雲端同步功能
- 離線存取功能
- 音頻朗讀功能
- 社群分享功能（僅提供文字導出）
